// Get the webhook data
const body = $input.first().json.body;

// Get messages array from the incoming request
let messages = body.messages || [];

// Filter out any empty or invalid messages to keep the history clean
const cleanMessages = messages
  .filter(msg => msg.role && msg.content && msg.content.trim() !== '')
  .map(msg => ({
    role: msg.role,
    // Ensure content is always a string, as required by the AI model
    content: typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content)
  }));

// Return a SINGLE item with the entire message history nested under the 'messages' key.
// This is the correct format the OpenAI node is expecting.
return [{
  json: {
    messages: cleanMessages
  }
}];
